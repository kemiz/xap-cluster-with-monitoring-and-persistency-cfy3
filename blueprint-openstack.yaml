tosca_definitions_version: cloudify_dsl_1_0

imports:
    - http://www.getcloudify.org/spec/cloudify/3.2/types.yaml
    - http://www.getcloudify.org/spec/diamond-plugin/1.2/plugin.yaml
    - http://www.getcloudify.org/spec/openstack-plugin/1.2/plugin.yaml
    - https://raw.githubusercontent.com/kemiz/monitored-server-cfy3/master/types/monitored-server-types.yaml
    - https://raw.githubusercontent.com/kemiz/xap-4-cloudify-3/3.2m8/commons/xap-blueprint-commons.yaml
    - https://raw.githubusercontent.com/kemiz/logstash-cfy3/3.2/types/logstash.yaml
    - https://raw.githubusercontent.com/kemiz/elasticsearch-cfy3/3.2/types/elasticsearch.yaml

inputs:

  image:
    type: string

  flavor:
    type: string

  agent_user:
    type: string

  xap_management_security_group:
    type: string
    default: 'xap_management_security_group'

  xap_container_security_group:
    type: string    
    default: 'xap_container_security_group'

  elasticsearch_api_port:
    default: 9200
    description: >
      elasticsearch port

  elasticsearch_cluster_port:
    default: 9300
    description: >
      elasticsearch cluster port

  logstash_inbound_port:
    default: 4560
    description: >
      logstash inbound port

  logstash_outbound_port:
    default: 9200
    description: >
      logstash outbound port

  logstash_config_filename:
    description: >
      Configuration filename

  logstash_config_filepath:
    description: >
      Configuration file path
      
node_templates:

  xap_management_security_group:
      type: cloudify.openstack.nodes.SecurityGroup
      properties:
          resource_id: { get_input: xap_management_security_group }
          security_group:
              description: Security group for xap_management_security_group
          rules:
              - remote_ip_prefix: 0.0.0.0/0
                port: 8099
              - remote_ip_prefix: 0.0.0.0/0
                port: 9099
              - remote_ip_prefix: 0.0.0.0/0
                port_range_min: 7122
                port_range_max: 7222
              - direction: egress
                remote_ip_prefix: 0.0.0.0/0
                port_range_min: 7122
                port_range_max: 7222
              - remote_ip_prefix: 0.0.0.0/0
                port: 4174
              - direction: egress
                remote_ip_prefix: 0.0.0.0/0
                port: 4174
              - remote_ip_prefix: 0.0.0.0/0
                port_range_min: 7102
                port_range_max: 7104
              - direction: egress
                remote_ip_prefix: 0.0.0.0/0
                port_range_min: 7102
                port_range_max: 7104


  xap_container_security_group:
      type: cloudify.openstack.nodes.SecurityGroup
      properties:
          resource_id: { get_input: xap_container_security_group }
          security_group:
              description: Security group for xap_container_security_group
          rules:
              - remote_ip_prefix: 0.0.0.0/0
                port_range_min: 7122
                port_range_max: 7222
              - direction: egress
                remote_ip_prefix: 0.0.0.0/0
                port_range_min: 7122
                port_range_max: 7222
              - remote_ip_prefix: 0.0.0.0/0
                port: 4174
              - direction: egress
                remote_ip_prefix: 0.0.0.0/0
                port: 4174
              - remote_ip_prefix: 0.0.0.0/0
                port_range_min: 7102
                port_range_max: 7104
              - direction: egress
                remote_ip_prefix: 0.0.0.0/0
                port_range_min: 7102
                port_range_max: 7104

  xap_container_vm:
      type: monitoredhosts.openstack.nodes.MonitoredServer
      instances:
          deploy: 1
      properties:
        server:
            image: { get_input: image }
            flavor: { get_input: flavor }
      relationships:
          - target: xap_container_security_group
            type: cloudify.openstack.server_connected_to_security_group

  xap_management_vm:
      type: monitoredhosts.openstack.nodes.MonitoredServer
      instances:
          deploy: 1
      properties:
          server:
              image: { get_input: image }
              flavor: { get_input: flavor }
      relationships:
          - target: floatingip
            type: cloudify.openstack.server_connected_to_floating_ip
          - target: xap_management_security_group
            type: cloudify.openstack.server_connected_to_security_group

  floatingip:
      type: cloudify.openstack.nodes.FloatingIP

  xap_management:
      type: xap_type
      properties:
          lus_cnt: 1
          global_lus_cnt: 0
          gsm_cnt: 1
          global_gsm_cnt: 0
          gsc_cnt: 0
          GSM_JAVA_OPTIONS: -Xms128m -Xmx128m
      relationships:
          -   target: xap_management_vm
              type: cloudify.relationships.contained_in

  xap_container:
      type: xap_type
      properties:
          gsc_cnt: 1
          GSC_JAVA_OPTIONS: -Xms128m -Xmx128m
      relationships:
          -   target: xap_container_vm
              type: cloudify.relationships.contained_in
          -   target: xap_management
              type: xap_connected_to_lus

  webui:
      type: xap_webui_type
      relationships:
          - target: xap_management_vm
            type: cloudify.relationships.contained_in
          - target: xap_management
            type: cloudify.relationships.depends_on

  elasticsearch_logstash_host:
    type: monitoredhosts.openstack.nodes.MonitoredServer
    relationships:
      - target: elasticsearch_logstash_security_group
        type: cloudify.openstack.server_connected_to_security_group

  elasticsearch:
    type: elasticsearch.nodes.Elasticsearch
    properties:
      api_port: { get_input: elasticsearch_api_port }
      cluster_port: { get_input: elasticsearch_cluster_port }
    relationships:
      - type: cloudify.relationships.contained_in
        target: elasticsearch_logstash_host

  logstash:
    type: logstash.nodes.Logstash
    properties:
      conf_filepath: { get_input: logstash_config_filepath }
      conf_filename: { get_input: logstash_config_filename }
    relationships:
      - type: cloudify.relationships.contained_in
        target: elasticsearch_logstash_host

  elasticsearch_logstash_security_group:
    type: cloudify.openstack.nodes.SecurityGroup
    properties:
      security_group:
        name: elasticsearch_security_group
      rules:
        - remote_ip_prefix: 0.0.0.0/0
          port: { get_property: [ elasticsearch, api_port ] }
        - remote_ip_prefix: 0.0.0.0/0
          port: { get_property: [ elasticsearch, cluster_port ] }
        - remote_ip_prefix: 0.0.0.0/0
          port: { get_input: logstash_inbound_port }
        - remote_ip_prefix: 0.0.0.0/0
          port: { get_input: logstash_outbound_port }

